# OKX API 接入指南

## 一、获取OKX API密钥

### 1. 创建OKX账户
1. 访问 [OKX官网](https://www.okx.com)
2. 注册并完成KYC认证（根据交易额度要求）
3. 启用双重身份验证（2FA）增强安全性

### 2. 生成API密钥
1. 登录OKX账户
2. 进入【账户】→【API】→【创建API】
3. 选择"交易"权限（根据需求选择）
4. 设置API密钥名称和权限

### 3. 关键安全设置
- **IP白名单**：务必设置IP白名单，只允许服务器IP访问
- **权限控制**：
  - 读取权限：行情查询、账户余额查询
  - 交易权限：下单、撤单、改单
  - 提现权限：谨慎开启（通常不需要）
- **API密钥保管**：
  - API Key：公开标识
  - Secret Key：机密信息，永不泄露
  - Passphrase：交易密码，额外安全层

## 二、API密钥权限建议

### 最小权限原则
```
✅ 读取权限：获取行情、账户信息
✅ 交易权限：现货交易、订单管理
❌ 提现权限：禁用（除非必要）
❌ 内部转账：禁用
```

### 推荐权限配置
- 行情数据：读取
- 交易功能：现货交易
- 账户信息：读取
- 其他权限：全部禁用

## 三、API速率限制

### REST API限制
- 公共接口：20次/秒
- 私有接口：10次/秒（基于UID）
- 批量接口：5次/秒

### WebSocket限制
- 连接数：最多20个连接
- 订阅数：每个连接最多240个频道
- 消息频率：高频消息可能被限制

## 四、环境配置

### 1. 创建环境配置文件
创建 `.env` 文件（不要提交到版本控制）：
```bash
# OKX API配置
OKX_API_KEY=your_api_key_here
OKX_SECRET_KEY=your_secret_key_here
OKX_PASSPHRASE=your_passphrase_here

# 交易设置
OKX_TESTNET=true  # 测试网开关
OKX_SANDBOX=true   # 沙盒环境

# 网络配置
OKX_REST_URL=https://www.okx.com
OKX_WS_PUBLIC_URL=wss://ws.okx.com:8443/ws/v5/public
OKX_WS_PRIVATE_URL=wss://ws.okx.com:8443/ws/v5/private

# 代理设置（如果需要）
HTTP_PROXY=
HTTPS_PROXY=
```

### 2. 安全最佳实践
1. 使用环境变量存储密钥
2. 设置IP白名单限制
3. 定期轮换API密钥
4. 监控API使用情况
5. 使用子账户进行交易隔离

## 五、测试网配置

### 测试网API端点
- REST: `https://www.okx.com` (相同主网)
- WebSocket: `wss://wspap.okx.com:8443/ws/v5/public?brokerId=9999`

### 测试网功能
- 模拟交易环境
- 虚拟资金交易
- 完整的API功能测试
- 无真实资金风险

## 六、错误处理建议

### 常见错误码
- 50000：服务暂时不可用
- 50001：频率限制
- 50002：系统错误
- 50004：禁止访问
- 50005：密钥不存在
- 50006：用户不存在
- 50008：货币不存在
- 50009：市场不存在
- 50011：数量太小
- 50012：数量精度错误
- 50013：价格精度错误
- 50014：交易金额太小
- 50015：无效的交易金额
- 50016：合约不存在

### 重试策略
- 50000/50002：指数退避重试
- 50001：等待频率限制解除
- 其他错误：记录日志并停止操作

## 七、监控和日志

### 必需监控指标
- API调用成功率
- 响应时间分布
- 频率限制使用情况
- 错误率统计
- 订单执行状态

### 日志记录
- 所有API请求和响应
- 错误详情和堆栈跟踪
- 交易执行结果
- 资金变动记录

## 八、推荐工具

### Python库
- `ccxt`: 统一的加密货币交易所接口
- `websockets`: WebSocket客户端
- `aiohttp`: 异步HTTP客户端
- `python-dotenv`: 环境变量管理

### 监控工具
- Prometheus: 指标收集
- Grafana: 数据可视化
- Sentry: 错误监控
- ELK Stack: 日志分析

## 九、紧急处理流程

### API密钥泄露
1. 立即在OKX平台禁用API密钥
2. 检查账户资金安全
3. 生成新的API密钥
4. 更新所有环境配置

### 频率限制
1. 降低请求频率
2. 实现请求队列
3. 使用批量接口减少调用次数
4. 监控并优化API使用模式

---

## 总结

遵循这些指南可以确保您的OKX API集成安全、稳定且高效。始终遵循最小权限原则，并实施完善的监控和错误处理机制。