# PRD 文档：基于 OKX 接口的现货自动化交易系统（增强版）

## 一、产品概述

本系统旨在通过接入 **OKX 官方 API（REST + WebSocket）**，实现加密货币现货的自动化量化交易。  
目标是提供 **稳定、可复现、低延迟、低成本** 的交易能力，支持多种策略开发、风险控制和资金管理，帮助用户在现货市场中实现长期稳健的交易表现。  

---

## 二、目标与价值

- **目标用户**：量化交易个人开发者、独立策略研究者、小型量化团队  
- **核心价值**：  
  - 稳定获取行情与账户数据  
  - 自动化执行交易策略（信号→下单→对账）  
  - 提供可配置的风控与资金管理  
  - 具备监控与可观测性，减少异常风险  
  - **专业级策略框架**：支持多市场状态自适应交易  
  - **机构级风险管理**：实时风险监控和动态控制  

---

## 三、系统架构与模块

### 1. 数据层
- **行情数据**：通过 WebSocket 订阅 `tickers/books/trades/candles`，并通过 REST 获取历史 K 线和交易数据。  
- **账户数据**：私有 WS 订阅余额、订单、成交更新，REST 用于对账。  
- **合约与精度**：调用 `GET /public/instruments?instType=SPOT` 获取交易对精度（tickSz/lotSz/minSz），用于下单前校验。  
- **市场数据增强**：实时波动率计算、流动性指标监控、订单簿深度分析  

### 2. 策略层（增强）
- **信号模块**：  
  - 基础指标：EMA、MACD、布林带、动量、均值回归等  
  - **多时间框架分析**：1m/5m/15m/1h/4h/1d 信号融合  
  - **动态参数优化**：根据市场波动率自动调整策略参数  
  - **信号确认机制**：成交量确认、价格行为过滤、市场状态验证  
  
- **市场状态识别系统**：  
  - 趋势/震荡识别：ADX、波动率收缩扩张指标  
  - 市场Regime检测：牛市、熊市、横盘环境识别  
  - 波动率状态：高波动/低波动市场适应  
  
- **策略组合器**：  
  - 支持多策略打分与仓位目标计算  
  - **风险平价分配**：基于波动率调整资金权重  
  - **动态杠杆控制**：根据市场波动率和风险承受能力调整  
  
- **目标仓位计算**：函数 `w_t = f(signal, risk_budget, market_state)` 映射到买卖数量  

### 3. 执行层（增强）
- **订单管理系统**：完整的订单生命周期管理，支持市价单、限价单、止损止盈单
- **执行引擎**：统一的订单执行接口，支持手续费和滑点模拟
- **下单接口**：REST 下单为主，支持 `clientOid` 幂等；批量下单、撤单接口提升效率。
- **订单类型**：限价单（PostOnly 优先）、市价单（小额补齐）、算法单（TWAP、冰山、追踪止损）。
- **失败处理**：自动重试、退避机制、重连与重订阅。
- **执行优化**：
  - **冲击成本模型**：大额交易价格影响预估
  - **流动性监测**：实时订单簿深度分析
  - **智能订单路由**：最优价格执行策略
  - **真实交易模拟**：精确的手续费计算和滑点模拟
  - **订单状态跟踪**：完整的订单状态机管理  

### 4. 风险管理（增强）
- **风险管理系统**：完整的风险评估和控制框架，支持多种风险计算方法
- **仓位计算器**：基于凯利公式、波动率、ATR等多种方法的仓位大小计算
- **止损止盈引擎**：智能止损止盈价格计算，支持多种止损策略
- **资金限制**：调用 `/account/max-avail-size` 获取最大可买/可卖。
- **风控规则**：
  - 单日最大亏损限制
  - 单笔滑点阈值
  - 单品种最大权重（如 ≤ 总资产 25%）
  - 强制止损：ATR 追踪止损、浮盈回撤止损
  - **实时VaR计算**：投资组合在险价值监控
  - **最大回撤控制**：硬性止损 + 软性风控
  - **相关性风险监控**：资产间相关性变化预警
- **库存管理**：目标持仓区间，避免无限买入或卖空。
- **风险等级评估**：动态风险等级划分和风险调整因子计算  

### 5. 监控与可观测性
- **监控指标**：延迟、成交率、滑点、资金费率暴露、仓位与余额。  
- **告警机制**：断线、订单异常、风控触发、API 限频。  
- **审计日志**：订单生命周期、账户变动、策略信号，支持回溯与复盘。  
- **性能KPI**：  
  - 夏普比率 > 1.5  
  - 最大回撤 < 15%  
  - 年化收益 > 20%  
  - 胜率 > 55%  
  - 盈亏比 > 1.2  

### 6. 回测验证系统（增强）
- **执行层集成**：完整的执行引擎和风险管理系统集成到回测中
- **真实交易模拟**：精确的手续费、滑点、订单执行状态模拟
- **Walk-Forward优化**：滚动时间窗口参数优化，防止过拟合
- **蒙特卡洛模拟**：测试策略在各种市场环境下的稳健性
- **样本外测试**：验证策略在未知数据上的表现
- **手续费建模**：精确的交易成本模拟
- **滑点模型**：基于历史数据的真实交易成本估计
- **专业级回测**：机构级的回测框架，支持复杂的交易逻辑和风险管理  

---

## 四、功能需求

### Must Have
1. 接入 OKX v5 API（REST+WS），实现行情与账户订阅。  
2. 下单、撤单、改单、批量操作，支持 PostOnly、clientOid 幂等。  
3. 风险管理：库存上限、日内亏损保护、止损止盈。  
4. 对账机制：REST/WS 双通道校验。  
5. 策略框架：支持至少 1–2 个基础策略（EMA 趋势、布林扩张）。  
6. **多时间框架信号融合**  
7. **基础市场状态识别**  

### Should Have
1. 算法单（TWAP、冰山、追踪止损）支持。  
2. 批量接口调用（降低拥堵风险）。  
3. 以计价币支付手续费选项，保证标的币库存完整性。  
4. 监控告警与 Prometheus/Grafana 接入。  
5. **动态参数优化系统**  
6. **实时VaR风险监控**  
7. **Walk-Forward回测验证**  

### Could Have
1. 策略回测模块（基于历史 K 线 + 手续费建模）。  
2. 多币种横截面动量/套利策略。  
3. Docker Compose 一键部署。  
4. **机器学习策略集成**  
5. **智能订单路由优化**  
6. **实时风险监控仪表盘**  

### Won't Have (暂不考虑)
1. 永续合约、期权支持（首期仅现货）。  
2. 高频交易/低延迟撮合优化（非目标）。  
3. 复杂分布式架构（单机足够）。  

---

## 五、用户场景

- **独立交易员 A**：希望在小额实盘上测试 EMA 策略，依赖系统的风控保护，防止资金爆仓。  
- **量化爱好者 B**：需要在本地跑多币种横截面动量策略，通过子账户隔离风险。  
- **小型量化团队 C**：需要统一监控与日志审计，支持策略迭代和复盘。  
- **专业交易员 D**：需要多市场状态自适应策略和机构级风险管理。  

---

## 六、非功能需求

- **性能**：行情延迟 < 200ms，订单提交 ACK < 500ms。  
- **安全**：API Key 最小权限 + IP 白名单；分账户隔离。  
- **稳定性**：断线重连、无损补订阅；订单对账一致性 ≥ 99.9%。  
- **可扩展性**：策略模块化，可快速接入新指标或逻辑。  
- **可靠性**：回测结果与实盘表现误差 < 5%。  

---

## 七、迭代规划（增强）

- **Phase 1 (MVP)**：接入 OKX v5 API、基础策略（EMA）、PostOnly 下单、止损止盈、REST/WS 对账。  
- **Phase 1.5 (策略增强)**：多时间框架信号融合、动态参数优化、基础市场状态识别  
- **Phase 2**：增加批量单、追踪止损、监控告警、策略扩展。  
- **Phase 2.5 (高级功能)**：机器学习策略集成、智能订单路由、实时风险监控仪表盘  
- **Phase 3**：支持多币种、回测模块、可视化仪表盘。  
- **Phase 4**：考虑期货/永续扩展。  

---

## 八、关键性能指标(KPI)

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 夏普比率 | > 1.5 | 风险调整后收益 |
| 最大回撤 | < 15% | 资金保护能力 |
| 年化收益 | > 20% | 绝对收益目标 |
| 胜率 | > 55% | 信号质量指标 |
| 盈亏比 | > 1.2 | 盈利效率 |
| 回测实盘误差 | < 5% | 策略可靠性 |

---

## 九、策略参考框架图（增强）

```
市场数据 → 多时间框架分析 → 信号生成 → 市场状态识别 → 策略选择
    ↓           ↓              ↓           ↓              ↓
风险监控 → 仓位计算器 → 执行引擎 → 订单管理器 → 绩效分析
    ↓           ↓              ↓           ↓              ↓
风险管理系统 → 资金分配 → 成本控制 → 对账校验 → 参数优化
    ↓
止损止盈引擎 → 风险等级评估 → 实时风险监控
```

## 十、交易成本控制

- **手续费优化**：maker-taker费率选择，VIP等级优化  
- **冲击成本管理**：大额交易分拆执行  
- **滑点控制**：基于流动性的限价单 placement  
- **最优执行**：TWAP/VWAP 等高级执行算法  

---

## 总结

本增强版PRD在原有基础上增加了专业级的交易策略框架、机构级风险管理体系、完整的回测验证系统以及明确的性能指标。这些改进将显著提升系统的实战性能、风险控制能力和长期稳定性，使其达到专业量化交易系统的水准。